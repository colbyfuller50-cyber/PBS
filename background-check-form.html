<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Palmetto Background Screening | Client Consent Form</title>

<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background: #f9f9f9; margin:0; padding:0; }
header { background: #1b3b1b; padding:1rem 0; text-align:center; }
header img { height:60px; }
.container { max-width:600px; margin:2rem auto; padding:2rem; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
h1, h2 { text-align:center; color:#1b3b1b; }
input, select, textarea { width:100%; padding:0.8rem; margin-bottom:1rem; border:1px solid #ccc; border-radius:5px; font-size:1rem; }
button { width:100%; padding:0.9rem; background:#4caf50; color:#fff; border:none; border-radius:5px; font-size:1rem; cursor:pointer; }
button:hover { background:#3e8e41; }
.status { font-weight:bold; color:#1b3b1b; text-align:center; margin-top:1rem; }
label { font-weight:bold; }
.consent-container { display:flex; align-items:center; margin-bottom:1rem; }
.consent-container input { width:auto; margin-right:10px; }
.hipaa-note { font-size:0.85rem; color:#555; margin-bottom:1rem; }
#submitBtn:disabled { background:#ccc; cursor:not-allowed; }
@media (max-width:600px) { .container { margin:1rem; padding:1rem; } }
</style>
</head>

<body>

<header>
  <img src="https://github.com/colbyfuller50-cyber/PBS/blob/main/PBS%20Logo.png?raw=true" alt="PBS Logo">
</header>

<div class="container">
  <h1>Background Check Consent Form</h1>
  <p>Please complete all fields and provide consent for us to perform a background check. Your information will be stored securely in compliance with HIPAA standards.</p>

  <form id="backgroundForm">
    <h2>Personal Information</h2>
    <label for="fullName">Full Name</label>
    <input type="text" id="fullName" required>

    <label for="dob">Date of Birth</label>
    <input type="date" id="dob" required>

    <label for="ssn">Social Security Number</label>
    <input type="text" id="ssn" maxlength="11" placeholder="XXX-XX-XXXX" required>

    <label for="address">Address</label>
    <textarea id="address" rows="3" required></textarea>

    <label for="phone">Phone Number</label>
    <input type="tel" id="phone" placeholder="(XXX) XXX-XXXX" required>

    <label for="email">Email</label>
    <input type="email" id="email" required>

    <h2>Consent for Background Check</h2>
    <div class="consent-container">
      <input type="checkbox" id="consent">
      <label for="consent">I authorize Palmetto Background Screening to perform a background check in compliance with FRCA regulations.</label>
    </div>

    <p class="hipaa-note">
      By submitting this form, you agree that your personal information will be stored securely and used solely for background check purposes. This form complies with HIPAA privacy standards.
    </p>

    <label for="notes">Additional Notes (optional)</label>
    <textarea id="notes" rows="3" placeholder="Any special instructions or notes..."></textarea>

    <button type="submit" id="submitBtn" disabled>Submit Form, Save PDF & Email</button>
    <p class="status" id="formStatus"></p>
  </form>
</div>

<script>
emailjs.init("YOUR_EMAILJS_USER_ID"); // Replace with your EmailJS user ID

const SUPABASE_URL = "https://snlhlitlenlqzabwaldg.supabase.co";
const SUPABASE_KEY = "sb_publishable_4tKa1p6b3bgSQpH8yTHIVg_X7Jmvk8b";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Enable submit button only if consent is checked
const consentCheckbox = document.getElementById("consent");
const submitBtn = document.getElementById("submitBtn");
consentCheckbox.addEventListener("change", () => {
  submitBtn.disabled = !consentCheckbox.checked;
});

// Form submission
document.getElementById("backgroundForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  submitBtn.disabled = true;
  document.getElementById("formStatus").textContent = "Submitting...";

  const fullName = document.getElementById("fullName").value;
  const dob = document.getElementById("dob").value;
  const ssn = document.getElementById("ssn").value;
  const address = document.getElementById("address").value;
  const phone = document.getElementById("phone").value;
  const email = document.getElementById("email").value;
  const notes = document.getElementById("notes").value;
  const timestamp = new Date().toISOString();

  try {
    // 1️⃣ Save data to Supabase table
    const { data: userData } = await supabaseClient.auth.getUser();
    const userId = userData.user.id;

    const { error: insertError } = await supabaseClient
      .from("background_forms")
      .insert([{
        user_id: userId,
        full_name: fullName,
        dob,
        ssn,
        address,
        phone,
        email,
        notes,
        consent: true,
        submitted_at: timestamp
      }]);
    if (insertError) throw insertError;

    // 2️⃣ Generate PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text("Palmetto Background Screening Consent Form", 10, 10);
    doc.text(`User ID: ${userId}`, 10, 20);
    doc.text(`Timestamp: ${timestamp}`, 10, 30);
    doc.text(`Full Name: ${fullName}`, 10, 40);
    doc.text(`Date of Birth: ${dob}`, 10, 50);
    doc.text(`SSN: ${ssn}`, 10, 60);
    doc.text(`Address: ${address}`, 10, 70);
    doc.text(`Phone: ${phone}`, 10, 80);
    doc.text(`Email: ${email}`, 10, 90);
    doc.text(`Consent: Given`, 10, 100);
    doc.text(`Notes: ${notes || "None"}`, 10, 110);

    const pdfBlob = doc.output('blob');
    const pdfName = `ConsentForm_${userId}_${Date.now()}.pdf`;

    // 3️⃣ Save PDF to Supabase Storage
    const { error: storageError } = await supabaseClient
      .storage
      .from("consent_forms")
      .upload(pdfName, pdfBlob, { contentType: "application/pdf" });
    if (storageError) throw storageError;

    // 4️⃣ Send PDF via EmailJS
    const reader = new FileReader();
    reader.onload = async function() {
      const base64 = reader.result.split(',')[1]; // Remove data prefix
      await emailjs.send("YOUR_SERVICE_ID","YOUR_TEMPLATE_ID",{
        to_email: "pbs@example.com",
        from_name: fullName,
        message: `Background Check Consent Form Submission - User ID: ${userId}`,
        attachment: base64,
        attachment_filename: pdfName
      });
    };
    reader.readAsDataURL(pdfBlob);

    document.getElementById("formStatus").textContent = "Form submitted, PDF saved & emailed successfully!";
    document.getElementById("backgroundForm").reset();
    submitBtn.disabled = true;
  } catch (err) {
    document.getElementById("formStatus").textContent = "Error: " + err.message;
    submitBtn.disabled = false;
  }
});
</script>

</body>
</html>
